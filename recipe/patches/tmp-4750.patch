From 9ae5642862b916755f4354b16f30b113f3d82e13 Mon Sep 17 00:00:00 2001
From: Chris Burr <christopher.burr@cern.ch>
Date: Thu, 9 Jan 2020 16:34:43 +0100
Subject: [PATCH 1/5] [ROOT-10472] Use find_package(Clang) to ensure
 dependencies are set correctly

---
 interpreter/CMakeLists.txt | 1 +
 1 file changed, 1 insertion(+)

diff --git a/interpreter/CMakeLists.txt b/interpreter/CMakeLists.txt
index 52b9c5ae51a..21ad6960902 100644
--- a/interpreter/CMakeLists.txt
+++ b/interpreter/CMakeLists.txt
@@ -393,6 +393,7 @@ Please install Python or specify the PYTHON_EXECUTABLE CMake variable.")
 if (builtin_clang)
   add_subdirectory(llvm/src/tools/clang EXCLUDE_FROM_ALL)
 else()
+  find_package(Clang REQUIRED)
   add_subdirectory(cling)
 endif()
 endif(builtin_llvm)

From 1f83ffb69ed823a6fa54d56125c4796d3041ba1b Mon Sep 17 00:00:00 2001
From: Chris Burr <christopher.burr@cern.ch>
Date: Thu, 9 Jan 2020 17:11:15 +0100
Subject: [PATCH 2/5] Remove content set by find_package(Clang)

---
 core/metacling/src/CMakeLists.txt    | 12 ------------
 core/metacling/test/CMakeLists.txt   |  9 ---------
 core/rootcling_stage1/CMakeLists.txt | 12 ------------
 interpreter/CMakeLists.txt           | 12 ++++++------
 4 files changed, 6 insertions(+), 39 deletions(-)

diff --git a/core/metacling/src/CMakeLists.txt b/core/metacling/src/CMakeLists.txt
index b8b3bd24236..0b9b864b7a1 100644
--- a/core/metacling/src/CMakeLists.txt
+++ b/core/metacling/src/CMakeLists.txt
@@ -65,18 +65,6 @@ add_dependencies(MetaCling CLING)
 
 ##### libCling #############################################################
 
-if(NOT builtin_clang)
-  set(prefixed_link_libraries)
-  foreach(dep ${CLING_DEPEND_LIBS})
-    if("${dep}" MATCHES "^clang")
-      set(dep "${LLVM_LIBRARY_DIR}/lib${dep}.a")
-     endif()
-     list(APPEND prefixed_link_libraries "${dep}")
-   endforeach()
-  set(LINK_LIBS "${prefixed_link_libraries}")
-  link_directories("${LLVM_LIBRARY_DIR}")
-endif()
-
 # We need to paste the content of the cling plugins disabling link symbol optimizations.
 set(CLING_PLUGIN_LINK_LIBS)
 if (clad)
diff --git a/core/metacling/test/CMakeLists.txt b/core/metacling/test/CMakeLists.txt
index 30a9fcb094e..be7099db838 100644
--- a/core/metacling/test/CMakeLists.txt
+++ b/core/metacling/test/CMakeLists.txt
@@ -20,15 +20,6 @@ include_directories(
   )
 
 set(LLVM_DEPS LLVMSupport)
-if(NOT builtin_clang)
-
-  # FIXME: Passing only LLVMSupport when we are using an external clang does not
-  # expand the transitive dependencies. For instance LLVMSupport should expand
-  # to LLVMSupport LLVMDemangle and optionally curses.
-  # For a unknown reasons using clingInterpreter enables such expansion...
-  set(LLVM_DEPS clingInterpreter)
-  link_directories("${LLVM_LIBRARY_DIR}")
-endif()
 
 ROOT_ADD_UNITTEST_DIR(Core RIO ${LLVM_DEPS})
 
diff --git a/core/rootcling_stage1/CMakeLists.txt b/core/rootcling_stage1/CMakeLists.txt
index 5cc5c9ca3d4..33558fa371b 100644
--- a/core/rootcling_stage1/CMakeLists.txt
+++ b/core/rootcling_stage1/CMakeLists.txt
@@ -18,18 +18,6 @@ else()
   endif()
 endif()
 
-if(NOT builtin_clang)
-  set(prefixed_link_libraries)
-  foreach(dep ${CLING_DEPEND_LIBS})
-    if("${dep}" MATCHES "^clang")
-      set(dep "${LLVM_LIBRARY_DIR}/lib${dep}.a")
-     endif()
-     list(APPEND prefixed_link_libraries "${dep}")
-   endforeach()
-  set(LINK_LIBS "${prefixed_link_libraries}")
-  link_directories("${LLVM_LIBRARY_DIR}")
-endif()
-
 ROOT_EXECUTABLE(rootcling_stage1 src/rootcling_stage1.cxx
                               $<TARGET_OBJECTS:Clib>
                               $<TARGET_OBJECTS:ClingUtils>
diff --git a/interpreter/CMakeLists.txt b/interpreter/CMakeLists.txt
index 21ad6960902..4c3bc7c0336 100644
--- a/interpreter/CMakeLists.txt
+++ b/interpreter/CMakeLists.txt
@@ -390,12 +390,12 @@ Please install Python or specify the PYTHON_EXECUTABLE CMake variable.")
   set(BACKEND_PACKAGE_STRING "LLVM ${LLVM_PACKAGE_VERSION}")
 
 
-if (builtin_clang)
-  add_subdirectory(llvm/src/tools/clang EXCLUDE_FROM_ALL)
-else()
-  find_package(Clang REQUIRED)
-  add_subdirectory(cling)
-endif()
+  if (builtin_clang)
+    add_subdirectory(llvm/src/tools/clang EXCLUDE_FROM_ALL)
+  else()
+    find_package(Clang REQUIRED)
+    add_subdirectory(cling)
+  endif()
 endif(builtin_llvm)
 
 #---Export the include directories------------------------------------------------------------------

From 3402b19a5a86cfa34e35132a820aac33796b1154 Mon Sep 17 00:00:00 2001
From: Chris Burr <christopher.burr@cern.ch>
Date: Thu, 9 Jan 2020 17:34:41 +0100
Subject: [PATCH 3/5] Add find_package(LLVM)

---
 interpreter/CMakeLists.txt | 1 +
 1 file changed, 1 insertion(+)

diff --git a/interpreter/CMakeLists.txt b/interpreter/CMakeLists.txt
index 4c3bc7c0336..a6f1c4a1d6c 100644
--- a/interpreter/CMakeLists.txt
+++ b/interpreter/CMakeLists.txt
@@ -390,6 +390,7 @@ Please install Python or specify the PYTHON_EXECUTABLE CMake variable.")
   set(BACKEND_PACKAGE_STRING "LLVM ${LLVM_PACKAGE_VERSION}")
 
 
+  find_package(LLVM REQUIRED)
   if (builtin_clang)
     add_subdirectory(llvm/src/tools/clang EXCLUDE_FROM_ALL)
   else()

From b2f8a7a9ddf3f86c6cb265f363c4573ef139304f Mon Sep 17 00:00:00 2001
From: Chris Burr <christopher.burr@cern.ch>
Date: Thu, 9 Jan 2020 17:47:51 +0100
Subject: [PATCH 4/5] Revert changes to core/metacling/test/CMakeLists.txt

---
 core/metacling/test/CMakeLists.txt | 9 +++++++++
 1 file changed, 9 insertions(+)

diff --git a/core/metacling/test/CMakeLists.txt b/core/metacling/test/CMakeLists.txt
index be7099db838..30a9fcb094e 100644
--- a/core/metacling/test/CMakeLists.txt
+++ b/core/metacling/test/CMakeLists.txt
@@ -20,6 +20,15 @@ include_directories(
   )
 
 set(LLVM_DEPS LLVMSupport)
+if(NOT builtin_clang)
+
+  # FIXME: Passing only LLVMSupport when we are using an external clang does not
+  # expand the transitive dependencies. For instance LLVMSupport should expand
+  # to LLVMSupport LLVMDemangle and optionally curses.
+  # For a unknown reasons using clingInterpreter enables such expansion...
+  set(LLVM_DEPS clingInterpreter)
+  link_directories("${LLVM_LIBRARY_DIR}")
+endif()
 
 ROOT_ADD_UNITTEST_DIR(Core RIO ${LLVM_DEPS})
 

From 152abebe480e1e3139a33ddc9c342fd6ead06096 Mon Sep 17 00:00:00 2001
From: Chris Burr <chrisburr@users.noreply.github.com>
Date: Fri, 10 Jan 2020 09:47:33 +0100
Subject: [PATCH 5/5] Remove accidentally included find_package(LLVM)

---
 interpreter/CMakeLists.txt | 1 -
 1 file changed, 1 deletion(-)

diff --git a/interpreter/CMakeLists.txt b/interpreter/CMakeLists.txt
index a6f1c4a1d6c..4c3bc7c0336 100644
--- a/interpreter/CMakeLists.txt
+++ b/interpreter/CMakeLists.txt
@@ -390,7 +390,6 @@ Please install Python or specify the PYTHON_EXECUTABLE CMake variable.")
   set(BACKEND_PACKAGE_STRING "LLVM ${LLVM_PACKAGE_VERSION}")
 
 
-  find_package(LLVM REQUIRED)
   if (builtin_clang)
     add_subdirectory(llvm/src/tools/clang EXCLUDE_FROM_ALL)
   else()

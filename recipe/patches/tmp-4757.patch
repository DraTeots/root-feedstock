From a5ed407a84e0459bfcca8ce0b6423d29e44a79b4 Mon Sep 17 00:00:00 2001
From: Chris Burr <christopher.burr@cern.ch>
Date: Fri, 10 Jan 2020 18:47:22 +0100
Subject: [PATCH] Disable SetLibraryPath for RPATH builds

---
 rootx/CMakeLists.txt | 4 ++++
 rootx/src/rootx.cxx  | 5 ++++-
 2 files changed, 8 insertions(+), 1 deletion(-)

diff --git a/rootx/CMakeLists.txt b/rootx/CMakeLists.txt
index d02d727204e..f19a5d3f73e 100644
--- a/rootx/CMakeLists.txt
+++ b/rootx/CMakeLists.txt
@@ -56,3 +56,7 @@ if(x11 OR cocoa)
     ${CMAKE_BINARY_DIR}/include/rootCommandLineOptionsHelp.h
   )
 endif()
+
+if(rpath)
+  add_definitions(-DIS_RPATH_BUILD=1)
+endif()
diff --git a/rootx/src/rootx.cxx b/rootx/src/rootx.cxx
index dfb85228207..9a9a7964653 100644
--- a/rootx/src/rootx.cxx
+++ b/rootx/src/rootx.cxx
@@ -148,7 +148,7 @@ static void SetRootSys()
    }
 }
 
-
+#ifndef IS_RPATH_BUILD
 static void SetLibraryPath()
 {
 #ifdef ROOTPREFIX
@@ -207,6 +207,7 @@ static void SetLibraryPath()
    }
 #endif
 }
+#endif
 
 extern "C" {
    static void SigUsr1(int);
@@ -451,8 +452,10 @@ int main(int argc, char **argv)
       argvv[1+i] = argv[i];
    argvv[1+i] = 0;
 
+#ifndef IS_RPATH_BUILD
    // Make sure library path is set
    SetLibraryPath();
+#endif
 
    // Execute actual ROOT module
    execv(arg0, argvv);
